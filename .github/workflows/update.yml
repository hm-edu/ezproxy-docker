name: update-proxy

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"

jobs:
  determine-container:
    runs-on: ubuntu-latest
    container: 
      image: ghcr.io/hm-edu/ezproxy-docker:main
      options: "--entrypoint /bin/bash"
    outputs:
      version: ${{ steps.version.outputs.ezproxy_version }}
    steps:
      - name: Check version
        id: version
        run: |
          VERSION="$(/usr/local/ezproxy/ezproxy -v | grep -oP "EZproxy \d+\.\d+\.\d+" | tr -d '\n')"
          echo "name=ezproxy_version::$VERSION" >> $GITHUB_OUTPUT
  determine-server:
    runs-on: ubuntu-latest
    needs: determine-container
    steps:
      - name: Download server
        run: | 
          wget -O ezproxy https://help.oclc.org/@api/deki/files/9850/ezproxy-linux.bin
          chmod +x ezproxy
      - name: Check version
        id: version
        run: |
          VERSION="$(ezproxy -v | grep -oP "EZproxy \d+\.\d+\.\d+" | tr -d '\n')"
          echo "name=ezproxy_version::$VERSION" >> $GITHUB_OUTPUT